local passwordFile = "startup.lua"
local encryptionScript = "encryptFS"
local decryptionScript = "startup"

function bootAnimation(stage)
  term.clear()
  term.setCursorPos(1,1)
  print("CatAiOs is booting...")
  stages = {
  "*---*\n|CAT|\n| I |\n| OS|\n[#  ]",
  "*---*\n|CAT|\n| I |\n| OS|\n[ # ]",
  "*---*\n|CAT|\n| I |\n| OS|\n[  #]"
  }
  print(stages[stage])
end

-- Read the password from the .password file
while true do
  print("Enter the system password")
  password = read("*")
  print("Enter it again")
  if password == read("*") then
    break
  else
    print("the passwords dont match")
  end
end

-- Decrypt a single file
local function decryptFile(filePath)
  local file = fs.open(filePath, "r")
  if file then
    local encryptedData = file.readAll()
    file.close()

    local decryptedData = ""
    local temp = 0
    local tempb = 0
    local tempc = 0
    for i = 1, #encryptedData do
      temp = temp + 1
      if temp > 2000 then
        sleep(0)
        temp = 0
        tempb = tempb + 1
        if tempb > 3 then
          tempb = 0
          tempc = tempc + 1
          bootAnimation(tempc)
          if tempc == 3 then
            tempc = 0
          end
        end
      end
      local byte = encryptedData:byte(i)
      local passwordByte = password:byte((i - 1) % #password + 1)
      local decryptedByte = bit32.bxor(byte, passwordByte)
      decryptedData = decryptedData .. string.char(decryptedByte)
    end

    file = fs.open(filePath, "w")
    if file then
      file.write(decryptedData)
      file.close()
    end
  end
end

-- Decrypt all files in the file system except itself, the .password file, and the encryption and decryption scripts
local function decryptFiles()
  local function decryptFolder(folderPath)
    local files = fs.list(folderPath)
    for _, file in ipairs(files) do
      sleep(0.5)
      local filePath = fs.combine(folderPath, file)
      if fs.isDir(filePath) then
        decryptFolder(filePath)
      elseif filePath ~= shell.getRunningProgram() and filePath ~= passwordFile and filePath ~= encryptionScript and filePath ~= decryptionScript then
        decryptFile(filePath)
      end
    end
  end

  decryptFolder("/")
end

print("Decrypting file system, this might take a while...")
decryptFiles()
print("Decryption completed.")
shell.run("start")
