counter = 0xFFFFFF
local passwordFile = ".password"
local encryptionScript = "encryptFS.lua"
local decryptionScript = "startup"

-- Read the password from the .password file
local password = nil
if fs.exists(passwordFile) then
  local file = fs.open(passwordFile, "r")
  password = file.readAll()
  file.close()
end

-- Check if the password is set
if not password or password == "" then
  print("Password not set. Please set the password in the .password file.")
  return
end

function fade()
  counter = counter - 1
  term.setPaletteColor(colors.black,counter)
  term.setPaletteColor(colors.blue,counter)
  term.setPaletteColor(colors.brown,counter)
  term.setPaletteColor(colors.cyan,counter)
  term.setPaletteColor(colors.gray,counter)
  term.setPaletteColor(colors.green,counter)
  term.setPaletteColor(colors.lightBlue,counter)
  term.setPaletteColor(colors.lightGray,counter)
  term.setPaletteColor(colors.lime,counter)
  term.setPaletteColor(colors.magenta,counter)
  term.setPaletteColor(colors.orange,counter)
  term.setPaletteColor(colors.pink,counter)
  term.setPaletteColor(colors.purple,counter)
  term.setPaletteColor(colors.red,counter)
  term.setPaletteColor(colors.white,counter)
  term.setPaletteColor(colors.yellow,counter)
end

function bar(p, t, f)
  term.clear()
  term.setCursorPos(1, 1)
  print("Encrypting", f)
  print(string.rep("_", 20))
  term.setCursorPos(1, 2)
  print(string.rep("#", (p / t) * 20))
  print((p / t) * 100)
end

-- Encrypt a single file
local function encryptFile(filePath)
  local temp = 0
  local file = fs.open(filePath, "r")
  if file then
    local data = file.readAll()
    file.close()

    local encryptedData = ""
    for i = 1, #data do
      temp = temp + 1
      if temp > 2000 then
        fade()
        bar(i, #data, filePath)
        sleep(0)
        temp = 0
      end
      local byte = data:byte(i)
      local passwordByte = password:byte((i - 1) % #password + 1)
      local encryptedByte = bit32.bxor(byte, passwordByte)
      encryptedData = encryptedData .. string.char(encryptedByte)
    end

    file = fs.open(filePath, "w")
    if file then
      file.write(encryptedData)
      file.close()
    end
  end
end

-- Encrypt all files in the file system except itself, the .password file, and the encryption and decryption scripts
local function encryptFiles()
  local function encryptFolder(folderPath)
    local files = fs.list(folderPath)
    for _, file in ipairs(files) do
      print("Encrypting", file, "inside", folderPath)
      sleep(0)
      local filePath = fs.combine(folderPath, file)
      if fs.isDir(filePath) then
        encryptFolder(filePath)
      elseif filePath ~= shell.getRunningProgram() and filePath ~= passwordFile and filePath ~= encryptionScript and filePath ~= decryptionScript then
        encryptFile(filePath)
      end
    end
  end

  encryptFolder("/")
end

print("Encrypting file system, this might take a while...")
encryptFiles()
print("Encryption completed.")
counter = 0
term.setPaletteColor(colors.black,counter)
term.setPaletteColor(colors.blue,counter)
term.setPaletteColor(colors.brown,counter)
term.setPaletteColor(colors.cyan,counter)
term.setPaletteColor(colors.gray,counter)
term.setPaletteColor(colors.green,counter)
term.setPaletteColor(colors.lightBlue,counter)
term.setPaletteColor(colors.lightGray,counter)
term.setPaletteColor(colors.lime,counter)
term.setPaletteColor(colors.magenta,counter)
term.setPaletteColor(colors.orange,counter)
term.setPaletteColor(colors.pink,counter)
term.setPaletteColor(colors.purple,counter)
term.setPaletteColor(colors.red,counter)
term.setPaletteColor(colors.white,counter)
term.setPaletteColor(colors.yellow,counter)
os.shutdown()
